# Next Generate App - æ¶æ„ä¸è§„åˆ’

## ğŸ“ ç³»ç»Ÿå…¨æ™¯

> **Core Context**: å‰ç«¯ Flutter (Riverpod + Dio) + åç«¯ FastAPI (Windows + ZImage) + æœ¬åœ°å±€åŸŸç½‘é€šä¿¡

```mermaid
graph TB
    subgraph Frontend["Flutter Mobile App"]
        UI[UI Layer<br/>Riverpod Consumers]
        STATE[State Layer<br/>Notifiers & Providers]
        INFRA[Infra Layer<br/>Dio & SharedPreferences]
    end
    
    subgraph Backend["Windows Server (FastAPI)"]
        API[API Layer<br/>FastAPI Routes]
        CORE[Core Layer<br/>Worker & Queue]
        MODEL[Model Layer<br/>ZImage Engine]
    end
    
    UI --> STATE
    STATE --> INFRA
    INFRA -->|HTTP/JSON| API
    API --> CORE
    CORE --> MODEL
```

## ğŸ”„ å…³é”®ä¸šåŠ¡æµ (Critical Flows)

### 1. ç”Ÿæˆä»»åŠ¡ (Generation Pipeline)

```mermaid
sequenceDiagram
    participant U as User
    participant App as Flutter App
    participant API as FastAPI
    participant Q as Task Queue
    participant E as ZImage Engine
    
    U->>App: Submit Prompt
    App->>API: POST /tasks (Async)
    API->>Q: Enqueue Task
    API-->>App: Return Task(ID, status=submitted)
    Note right of API: Non-blocking response
    
    loop Background Processing
        Q->>E: Pop Task
        E->>E: Generate Image (GPU)
        E->>API: Update Status=completed
    end
    
    loop Client Polling
        App->>API: GET /tasks
        API-->>App: Return List[Task]
    end
```

### 2. è¿æ¥ç®¡ç† (Connectivity & State)

> **Design Decision**: ä½¿ç”¨ `NotifierProvider` åˆ†ç¦»çŠ¶æ€è¯»å–ä¸æ“ä½œï¼Œç¡®ä¿ IP å˜æ›´æ—¶è‡ªåŠ¨é‡å»º API å®ä¾‹ã€‚

```mermaid
graph LR
    SIP[serverIpProvider<br/>State: String] -->|watch| SAP[sdApiServiceProvider<br/>State: SdApiService]
    SAP -->|provides| API[Dio Instance]
    
    subgraph "Rebuild Logic"
        IP_CHANGE[IP Changed] --> SIP
        SIP -->|Trigger| SAP
        SAP -->|New BaseURL| API
    end
```

## ğŸ“¦ æ ¸å¿ƒæ•°æ®ç»“æ„ (Data Schema)

```mermaid
classDiagram
    class GenerationTask {
        +String id
        +String prompt
        +String? negative_prompt
        +String status
        +String created_at
        +String? completed_at
        +String? imageUrl
    }
    note for GenerationTask "Status: submitted | processing | completed | failed"
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆæ¸…å• (Tech Stack)

- **Frontend**: Flutter, Riverpod (State), GoRouter, Dio, CachedNetworkImage
- **Backend**: Python, FastAPI, Uvicorn, Diffusers (ZImage/BF16), Asyncio
- **Protocol**: HTTP REST, JSON
- **Storage**: 
  - Front: SharedPreferences (Config)
  - Back: JSON File (Task Metadata), Local File System (Images)

---
*æ³¨ï¼šå…·ä½“ä»£ç å®ç°è¯·ç›´æ¥å‚è€ƒå„æ¨¡å—æºç ï¼Œæœ¬æ–‡æ¡£ä»…ä½œä¸ºæ¶æ„ç´¢å¼•ã€‚*
